<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title | default: site.title }}</title>
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  {% seo %}
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <nav>
        <ul>
          {% for item in site.navigation %}
          {% assign context_str = item.contexts | join: ',' %}
          {% if item.children %}
          <li class="section" data-context="{{ context_str }}"><i class="{{ item.icon }}"></i> {{ item.title }}</li>
          <ul class="sidebar-sub" data-context="{{ context_str }}">
            {% for child in item.children %}
            {% assign child_context_str = child.contexts | join: ',' %}
            {% if child.children %}
            <li class="sub-section" data-context="{{ child_context_str }}"><i class="{{ child.icon }}"></i> {{
              child.title }}</li>
            <ul class="sidebar-sub-sub" data-context="{{ child_context_str }}">
              {% for grandchild in child.children %}
              {% assign grandchild_context_str = grandchild.contexts | join: ',' %}
              <li data-context="{{ grandchild_context_str }}"><a href="{{ grandchild.url | relative_url }}"><i
                    class="{{ grandchild.icon }}"></i> {{
                  grandchild.title }}</a></li>
              {% endfor %}
            </ul>
            {% else %}
            <li data-context="{{ child_context_str }}"><a href="{{ child.url | relative_url }}"><i
                  class="{{ child.icon }}"></i> {{ child.title }}</a></li>
            {% endif %}
            {% endfor %}
          </ul>
          {% else %}
          <li class="section" data-context="{{ context_str }}">
            <a href="{{ item.url | relative_url }}"><i class="{{ item.icon }}"></i> {{ item.title }}</a>
          </li>
          {% endif %}
          {% endfor %}
        </ul>
      </nav>

      <!-- Client-side Navigation Filtering -->
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // 1. Check current URL. If it's the landing page (baseurl/ or baseurl/index.html), do NOT filter (or hide sidebar completely?).
          // Based on request, landing page is special. Sidebar usually exists on 'default' layout.
          // If we are on landing page, we might want to hide sidebar or just let it accept 'all'.

          // 2. Get context
          const context = localStorage.getItem('swasthx_doc_context');

          // If no context is set, and we are NOT on the landing page, redirect to landing?
          // For now, let's assume if no context, show everything (developer mode) or redirect.
          // But user said "first visits the link -> common page".

          if (context) {
            const items = document.querySelectorAll('[data-context]');
            items.forEach(el => {
              const allowedContexts = el.getAttribute('data-context').split(',');
              if (!allowedContexts.includes(context)) {
                el.style.display = 'none';
              }
            });

            // Optional: Hide parents if all children are hidden?
            // This simple filter might leave empty headers. 
            // Current structure: .section is a <li>, following is <ul>.
            // If we hide the <ul> contents, we should likely hide the .section too.
            // This requires a bit more logic, but let's see how it looks first.
            // The .section itself has a context. If that context includes the current one, it shows.
            // Since we tagged parents with "phr, website", they will show even if children are empty?
            // Actually, in config I tagged "Release" as [phr] ONLY. So it will be hidden entirely for website.
            // "Database" is [phr, website]. But "Website Database" is [website].
            // So for PHR user:
            // Database (Visible) -> PHR DB (Visible), Website DB (Hidden).
            // Result: Database -> PHR DB. This is correct.
          }

          if (context) {
            const overviewLink = Array.from(document.querySelectorAll('.sidebar a')).find(a => a.textContent.trim() === 'Overview');
            if (overviewLink) {
              const iconHtml = overviewLink.querySelector('i') ? overviewLink.querySelector('i').outerHTML : '';
              if (context === 'phr') {
                overviewLink.innerHTML = `${iconHtml} PHR Overview`;
              } else if (context === 'website') {
                overviewLink.innerHTML = `${iconHtml} Website Overview`;
              }
            }
          }
        });
      </script>

    </div>

    <main>
      {{ content }}
    </main>
  </div>

  <footer>
    <div class="container">
      <p>&copy; {{ 'now' | date: "%Y" }} {{ site.title }}. All rights reserved.</p>
    </div>
  </footer>

  <script src="{{ '/assets/js/main.js' | relative_url }}"></script>
</body>

</html>